# フロントエンドプロキシ設定ガイド

## 📋 問題

Railwayで設定したドメイン（例: `poke-sup-production-c4e5.up.railway.app`）にアクセスすると、APIのJSONレスポンスが表示されるが、フロントエンド（サービス画面）が表示されない。

## ✅ 解決策

統合デプロイの場合、FlaskバックエンドがNext.jsフロントエンドサーバーにプロキシするように設定しました。

### 実装内容

1. **FlaskでNext.jsサーバーにプロキシ**
   - ルートパス（`/`）とAPI以外のパスをNext.jsサーバー（ポート3000）にプロキシ
   - APIパス（`/api/*`）はFlaskで直接処理

2. **統合起動スクリプト**
   - フロントエンド（Next.js）をポート3000で起動
   - バックエンド（Flask）をポート8080で起動
   - フロントエンドの起動を待ってからバックエンドを起動

3. **環境変数**
   - `FRONTEND_URL`: Next.jsサーバーのURL（デフォルト: `http://localhost:3000`）

## 🔧 設定確認

### 1. Dockerfileの確認

起動スクリプトが正しく設定されているか確認：

```dockerfile
CMD ["/app/start.sh"]
```

### 2. 環境変数の設定（オプション）

Railwayダッシュボードで、必要に応じて環境変数を設定：

- `FRONTEND_URL`: `http://localhost:3000`（デフォルト値で動作）

### 3. ポート設定

- **バックエンド（Flask）**: ポート8080（Railwayが自動設定）
- **フロントエンド（Next.js）**: ポート3000（内部通信）

## 🚀 デプロイ後の確認

### 正常な場合

1. **ルートパス（`/`）**: フロントエンドのページが表示される
2. **APIパス（`/api/*`）**: APIレスポンスが返される
3. **その他のパス**: フロントエンドのルーティングが動作する

### エラーの場合

ログで以下を確認：

```bash
# Railwayダッシュボード → デプロイメント → ログ
```

**フロントエンドが起動していない場合:**
```
Warning: Frontend did not start within 30 seconds
```

**解決方法:**
1. フロントエンドのビルドが成功しているか確認
2. `package.json`の`start`スクリプトが正しいか確認
3. ポート3000が利用可能か確認

## 📝 チェックリスト

- [ ] Dockerfileで起動スクリプトが設定されている
- [ ] `backend/app.py`でプロキシ機能が実装されている
- [ ] `backend/requirements.txt`に`requests`が追加されている
- [ ] フロントエンドのビルドが成功している
- [ ] デプロイ後、ルートパスでフロントエンドが表示される

## 🔍 トラブルシューティング

### 問題1: フロントエンドが表示されない

**症状:**
- ルートパスでAPI情報が表示される
- フロントエンドのページが表示されない

**確認:**
1. ログでフロントエンドの起動を確認
2. `FRONTEND_URL`環境変数が正しく設定されているか確認
3. フロントエンドのビルドが成功しているか確認

**解決:**
- フロントエンドのビルドエラーを修正
- 起動スクリプトの待機時間を調整（必要に応じて）

### 問題2: APIが動作しない

**症状:**
- APIエンドポイントが404を返す

**確認:**
1. APIルートが正しく登録されているか確認
2. `catch_all`関数がAPIパスを除外しているか確認

**解決:**
- `backend/routes/__init__.py`でルートが正しく登録されているか確認
- `catch_all`関数のAPIパス除外ロジックを確認

### 問題3: 静的ファイルが読み込まれない

**症状:**
- ページは表示されるが、CSSやJavaScriptが読み込まれない

**確認:**
1. Next.jsのビルドが成功しているか確認
2. `.next`ディレクトリが正しくコピーされているか確認

**解決:**
- Dockerfileで`.next`ディレクトリが正しくコピーされているか確認
- フロントエンドのビルドコマンドを確認

## 🔗 関連ドキュメント

- [RAILWAY_DEPLOY_GUIDE.md](./RAILWAY_DEPLOY_GUIDE.md) - Railwayデプロイガイド
- [QUICK_FIX_RAILWAY.md](./QUICK_FIX_RAILWAY.md) - エラー対応ガイド

---

*この設定で、統合デプロイでもフロントエンドが正しく表示されるはずです。*

